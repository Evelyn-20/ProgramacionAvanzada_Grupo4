@using Pasteleria.Abstracciones.ModeloUI
@model IEnumerable<Pasteleria.Abstracciones.ModeloUI.Categoria>

@{
    ViewData["Title"] = "Catálogo de Categorías";
    int pagina = ViewBag.Pagina ?? 1;
    int tam = ViewBag.Tam ?? 10;
    int total = ViewBag.Total ?? 0;
    string nombre = ViewBag.Nombre as string ?? "";
    int paginas = (int)Math.Ceiling(total / (double)tam);
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Catálogo de Categorías</h3>
        <div>
            <a asp-action="Crear" class="btn btn-primary">+ Nueva Categoría</a>
            <a asp-controller="Producto" asp-action="ListadoProductos" class="btn btn-outline-secondary">Volver al Inventario</a>
        </div>
    </div>

    @if (TempData["ok"] != null)
    {
        <div class="alert alert-success">@TempData["ok"]</div>
    }
    @if (TempData["err"] != null)
    {
        <div class="alert alert-danger">@TempData["err"]</div>
    }

    <form method="get" class="row g-2 mb-3">
        <div class="col-md-6">
            <input type="text" name="nombre" value="@nombre" class="form-control" placeholder="Buscar por nombre..." />
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-outline-secondary">Filtrar</button>
        </div>
    </form>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-striped align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width:80px;">ID</th>
                        <th style="width:100px;">Imagen</th>
                        <th>Nombre</th>
                        <th style="width:100px;">Activo</th>
                        <th style="width:250px;" class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in Model)
                    {
                        <tr>
                            <td>@c.IdCategoria</td>
                            <td>
                                @if (c.Imagen != null && c.Imagen.Length > 0)
                                {
                                    var b64 = Convert.ToBase64String(c.Imagen);
                                    <img src="data:image/png;base64,@b64"
                                         class="img-thumbnail" style="height:60px;width:60px;object-fit:cover;" />
                                }
                                else
                                {
                                    <div class="bg-light border rounded d-flex align-items-center justify-content-center"
                                         style="height:60px;width:60px;">
                                        <small class="text-muted">Sin imagen</small>
                                    </div>
                                }
                            </td>
                            <td>@c.NombreCategoria</td>
                            <td>@(c.Estado ? "Sí" : "No")</td>
                            <td class="text-end">
                                <div class="btn-group">
                                    <a asp-action="Editar" asp-route-id="@c.IdCategoria" class="btn btn-sm btn-outline-primary">Editar</a>
                                    <form asp-action="Eliminar" asp-route-id="@c.IdCategoria" method="post" onsubmit="return confirm('¿Eliminar la categoría @c.NombreCategoria?');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                    </form>
                                    <a asp-controller="Producto" asp-action="ListadoProductos" asp-route-IdCategoria="@c.IdCategoria" class="btn btn-sm btn-outline-secondary">Ver productos</a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (paginas > 1)
        {
            <div class="card-footer bg-white">
                <nav class="d-flex justify-content-center">
                    <ul class="pagination mb-0">
                        @for (int p = 1; p <= paginas; p++)
                        {
                            <li class="page-item @(p == pagina ? "active" : "")">
                                <a class="page-link" href="@Url.Action("ListadoCategorias", new { pagina = p, nombre })">@p</a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>
