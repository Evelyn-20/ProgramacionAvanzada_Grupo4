@model List<Pasteleria.Controllers.Api.CarritoApiController.Linea>

@{
    ViewData["Title"] = "Verificar Pedido";

    decimal subtotal = 0m, impuestos = 0m, total = 0m;

    string Curr(decimal v) => "₡" + v.ToString("N2");

    foreach (var l in (Model ?? Enumerable.Empty<Pasteleria.Controllers.Api.CarritoApiController.Linea>()))
    {
        var bruto = l.Precio * l.Cantidad;
        var dPct = Math.Clamp(l.DescuentoPorc ?? 0m, 0m, 100m);
        var dFijo = Math.Max(0m, l.DescuentoFijo ?? 0m);
        var netoSinImp = Math.Max(0m, bruto - (bruto * dPct / 100m) - dFijo);
        var imp = Math.Round(netoSinImp * (l.Impuesto / 100m), 2);

        subtotal += netoSinImp;
        impuestos += imp;
    }
    total = subtotal + impuestos;
}

<h4>Carrito</h4>

@if (Model is null || !Model.Any())
{
    <div class="alert alert-info">El carrito está vacío.</div>
    <div class="mt-3">
        <a class="btn btn-secondary" href="@Url.Action("Create", "Pedido")">Volver</a>
    </div>
}
else
{
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Producto</th>
                <th class="text-end">Cant.</th>
                <th class="text-end">Precio</th>
                <th class="text-end">Desc. %</th>
                <th class="text-end">Desc. fijo</th>
                <th class="text-end">Impuesto %</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var l in Model)
            {
                <tr>
                    <td>@l.Nombre</td>
                    <td class="text-end">@l.Cantidad</td>
                    <td class="text-end">@Curr(l.Precio)</td>
                    <td class="text-end">@((l.DescuentoPorc ?? 0).ToString("N2"))</td>
                    <td class="text-end">@Curr(l.DescuentoFijo ?? 0)</td>
                    <td class="text-end">@((l.Impuesto).ToString("N2"))</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="text-end">
        <div>Subtotal: <strong>@Curr(subtotal)</strong></div>
        <div>Impuestos: <strong>@Curr(impuestos)</strong></div>
        <div>Total: <strong>@Curr(total)</strong></div>
    </div>

    <div class="mt-3 text-end">
        <a class="btn btn-secondary" href="@Url.Action("Create", "Pedido")">Seguir comprando</a>
        <form class="d-inline" method="post" action="@Url.Action("Confirmar", "Pedido")">
            <button class="btn btn-primary">Confirmar pedido</button>
        </form>
    </div>
}
